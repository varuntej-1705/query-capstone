{% extends "base.html" %}

{% block title %}Interactive Visualization - EDA Application{% endblock %}

{% block content %}
<div class="header">
    <div class="header-title">
        <h1><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28"
                style="vertical-align: middle; margin-right: 8px;">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
                <line x1="2" y1="20" x2="22" y2="20" />
            </svg>Interactive Visualization</h1>
        <p>Create custom charts and explore your data visually</p>
    </div>
    <div class="header-actions">
        <select class="form-select" id="datasetSelect" style="min-width: 250px;" onchange="loadDatasetForViz()">
            <option value="">Select a dataset...</option>
        </select>
    </div>
</div>

<div class="grid grid-3">
    <!-- Chart Configuration -->
    <div class="card">
        <div class="card-header">
            <h3>
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <circle cx="12" cy="12" r="3" />
                    <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                </svg>
                Chart Settings
            </h3>
        </div>

        <div class="form-group">
            <label class="form-label">Chart Type</label>
            <select class="form-select" id="chartType" onchange="updateAxisOptions()">
                <option value="bar">Bar Chart</option>
                <option value="line">Line Chart</option>
                <option value="histogram">Histogram</option>
                <option value="scatter">Scatter Plot</option>
                <option value="box">Box Plot</option>
                <option value="heatmap">Correlation Heatmap</option>
                <option value="pie">Pie Chart</option>
            </select>
        </div>

        <div id="axisOptions">
            <div class="form-group" id="xAxisGroup">
                <label class="form-label">X Axis</label>
                <select class="form-select" id="xAxis">
                    <option value="">Select column...</option>
                </select>
            </div>

            <div class="form-group" id="yAxisGroup">
                <label class="form-label">Y Axis</label>
                <select class="form-select" id="yAxis">
                    <option value="">Select column...</option>
                </select>
            </div>

            <div class="form-group" id="colorGroup" style="display: none;">
                <label class="form-label">Color By (Optional)</label>
                <select class="form-select" id="colorBy">
                    <option value="">None</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Chart Title</label>
            <input type="text" class="form-input" id="chartTitle" placeholder="Enter chart title...">
        </div>

        <button class="btn btn-primary" onclick="generateChart()" style="width: 100%;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
            </svg>
            Generate Chart
        </button>
    </div>

    <!-- Chart Display -->
    <div class="card" style="grid-column: span 2;">
        <div class="card-header">
            <h3 id="chartDisplayTitle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                Chart Preview
            </h3>
            <div class="chart-actions">
                <button class="btn btn-sm btn-secondary" onclick="downloadChart()" id="downloadBtn" disabled>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Download
                </button>
            </div>
        </div>

        <div id="chartContainer" style="height: 450px;">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10" />
                    <line x1="12" y1="20" x2="12" y2="4" />
                    <line x1="6" y1="20" x2="6" y2="14" />
                </svg>
                <h3>No Chart Generated</h3>
                <p>Select a dataset and configure your chart options</p>
            </div>
        </div>
    </div>
</div>

<!-- Chart Gallery / History -->
<div class="card mt-4">
    <div class="card-header">
        <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
            </svg>
            Quick Charts
        </h3>
    </div>
    <div class="grid grid-4" id="quickCharts">
        <div class="dataset-card" onclick="quickChart('histogram')" style="text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"
                style="color: var(--primary); margin-bottom: 0.5rem;">
                <line x1="18" y1="20" x2="18" y2="10" />
                <line x1="12" y1="20" x2="12" y2="4" />
                <line x1="6" y1="20" x2="6" y2="14" />
            </svg>
            <h4>Distribution</h4>
            <p class="text-muted" style="font-size: 0.8rem;">Auto histogram</p>
        </div>
        <div class="dataset-card" onclick="quickChart('box')" style="text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"
                style="color: var(--secondary); margin-bottom: 0.5rem;">
                <rect x="3" y="8" width="18" height="8" rx="1" />
                <line x1="12" y1="8" x2="12" y2="4" />
                <line x1="12" y1="16" x2="12" y2="20" />
            </svg>
            <h4>Outliers</h4>
            <p class="text-muted" style="font-size: 0.8rem;">Box plots</p>
        </div>
        <div class="dataset-card" onclick="quickChart('heatmap')" style="text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"
                style="color: var(--accent); margin-bottom: 0.5rem;">
                <rect x="3" y="3" width="18" height="18" rx="2" />
                <rect x="7" y="7" width="3" height="3" />
                <rect x="14" y="7" width="3" height="3" />
                <rect x="7" y="14" width="3" height="3" />
                <rect x="14" y="14" width="3" height="3" />
            </svg>
            <h4>Correlations</h4>
            <p class="text-muted" style="font-size: 0.8rem;">Heatmap</p>
        </div>
        <div class="dataset-card" onclick="quickChart('scatter')" style="text-align: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"
                style="color: var(--success); margin-bottom: 0.5rem;">
                <circle cx="7" cy="15" r="2" />
                <circle cx="12" cy="9" r="2" />
                <circle cx="17" cy="17" r="2" />
                <circle cx="9" cy="5" r="2" />
                <circle cx="15" cy="12" r="2" />
            </svg>
            <h4>Relationships</h4>
            <p class="text-muted" style="font-size: 0.8rem;">Scatter plot</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDatasetId = null;
    let datasetInfo = null;
    let chartGenerated = false;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadDatasets();
    });

    async function loadDatasets() {
        try {
            const data = await apiGet('/api/datasets');
            const select = document.getElementById('datasetSelect');
            select.innerHTML = '<option value="">Select a dataset...</option>' +
                (data.datasets || []).map(d => `<option value="${d.id}">${d.name}</option>`).join('');
        } catch (error) {
            console.error('Failed to load datasets:', error);
        }
    }

    async function loadDatasetForViz() {
        const datasetId = document.getElementById('datasetSelect').value;

        if (!datasetId) {
            currentDatasetId = null;
            datasetInfo = null;
            return;
        }
        currentDatasetId = datasetId;
        showLoading();

        try {
            datasetInfo = await apiGet(`/api/datasets/${datasetId}`);
            populateColumnSelects();
            showToast('Dataset loaded', 'success');
        } catch (error) {
            console.error('Failed to load dataset:', error);
        }
        hideLoading();
    }
    function populateColumnSelects() {
        if (!datasetInfo) return;

        const columns = datasetInfo.info.column_names;
        const numericCols = datasetInfo.info.numeric_columns;
        const catCols = datasetInfo.info.categorical_columns;

        const allOptions = '<option value="">Select column...</option>' +
            columns.map(c => `<option value="${c}">${c}</option>`).join('');

        document.getElementById('xAxis').innerHTML = allOptions;
        document.getElementById('yAxis').innerHTML = allOptions;
        document.getElementById('colorBy').innerHTML = '<option value="">None</option>' +
            catCols.map(c => `<option value="${c}">${c}</option>`).join('');

        updateAxisOptions();
    }

    function updateAxisOptions() {
        const chartType = document.getElementById('chartType').value;

        const xGroup = document.getElementById('xAxisGroup');
        const yGroup = document.getElementById('yAxisGroup');
        const colorGroup = document.getElementById('colorGroup');

        // Reset visibility
        xGroup.style.display = 'block';
        yGroup.style.display = 'block';
        colorGroup.style.display = 'none';

        // Update labels and visibility based on chart type
        switch (chartType) {
            case 'histogram':
                document.querySelector('#xAxisGroup .form-label').textContent = 'Column';
                yGroup.style.display = 'none';
                break;
            case 'box':
                document.querySelector('#xAxisGroup .form-label').textContent = 'Columns (leave empty for all)';
                yGroup.style.display = 'none';
                break;
            case 'heatmap':
                xGroup.style.display = 'none';
                yGroup.style.display = 'none';
                break;
            case 'pie':
                document.querySelector('#xAxisGroup .form-label').textContent = 'Labels';
                document.querySelector('#yAxisGroup .form-label').textContent = 'Values';
                break;
            case 'scatter':
                document.querySelector('#xAxisGroup .form-label').textContent = 'X Axis';
                document.querySelector('#yAxisGroup .form-label').textContent = 'Y Axis';
                colorGroup.style.display = 'block';
                break;
            default:
                document.querySelector('#xAxisGroup .form-label').textContent = 'X Axis';
                document.querySelector('#yAxisGroup .form-label').textContent = 'Y Axis';
                colorGroup.style.display = 'block';
        }
    }

    async function generateChart() {
        if (!currentDatasetId) {
            showToast('Please select a dataset', 'warning');
            return;
        }

        const chartType = document.getElementById('chartType').value;
        const xAxis = document.getElementById('xAxis').value;
        const yAxis = document.getElementById('yAxis').value;
        const colorBy = document.getElementById('colorBy').value;
        const title = document.getElementById('chartTitle').value || getDefaultTitle(chartType, xAxis, yAxis);

        // Validate based on chart type
        if (['bar', 'line', 'scatter', 'pie'].includes(chartType) && (!xAxis || !yAxis)) {
            showToast('Please select X and Y axes', 'warning');
            return;
        }

        if (chartType === 'histogram' && !xAxis) {
            showToast('Please select a column', 'warning');
            return;
        }

        showLoading();

        try {
            const container = 'chartContainer';

            switch (chartType) {
                case 'bar':
                    await createBarChart(container, currentDatasetId, xAxis, yAxis, title, colorBy || null);
                    break;
                case 'line':
                    await createLineChart(container, currentDatasetId, xAxis, yAxis, title, colorBy || null);
                    break;
                case 'histogram':
                    await createHistogram(container, currentDatasetId, xAxis, title);
                    break;
                case 'scatter':
                    await createScatterPlot(container, currentDatasetId, xAxis, yAxis, colorBy || null, null, title);
                    break;
                case 'box':
                    await createBoxPlot(container, currentDatasetId, xAxis ? [xAxis] : null, title);
                    break;
                case 'heatmap':
                    await createHeatmap(container, currentDatasetId, title);
                    break;
                case 'pie':
                    // For pie, we need to aggregate first via local method
                    const data = datasetInfo.preview.data;
                    const counts = {};
                    data.forEach(row => {
                        const key = row[xAxis];
                        counts[key] = (counts[key] || 0) + (parseFloat(row[yAxis]) || 1);
                    });
                    createLocalPieChart(container, Object.keys(counts).slice(0, 10), Object.values(counts).slice(0, 10), title);
                    break;
            }

            chartGenerated = true;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('chartDisplayTitle').innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <line x1="18" y1="20" x2="18" y2="10"/>
                <line x1="12" y1="20" x2="12" y2="4"/>
                <line x1="6" y1="20" x2="6" y2="14"/>
            </svg>
            ${title}
        `;

        } catch (error) {
            console.error('Chart generation failed:', error);
        }

        hideLoading();
    }

    function getDefaultTitle(chartType, x, y) {
        switch (chartType) {
            case 'histogram': return `Distribution of ${x}`;
            case 'box': return 'Box Plot';
            case 'heatmap': return 'Correlation Matrix';
            case 'scatter': return `${x} vs ${y}`;
            case 'pie': return `${y} by ${x}`;
            default: return `${y} by ${x}`;
        }
    }

    function quickChart(type) {
        if (!currentDatasetId || !datasetInfo) {
            showToast('Please select a dataset first', 'warning');
            return;
        }

        document.getElementById('chartType').value = type;
        updateAxisOptions();

        const numericCols = datasetInfo.info.numeric_columns;

        if (type === 'histogram' && numericCols.length > 0) {
            document.getElementById('xAxis').value = numericCols[0];
        } else if (type === 'scatter' && numericCols.length >= 2) {
            document.getElementById('xAxis').value = numericCols[0];
            document.getElementById('yAxis').value = numericCols[1];
        }

        generateChart();
    }

    function downloadChart() {
        const chartDiv = document.getElementById('chartContainer');
        if (chartDiv && chartGenerated) {
            Plotly.downloadImage(chartDiv, {
                format: 'png',
                filename: 'eda_chart',
                height: 600,
                width: 800,
                scale: 2
            });
            showToast('Chart downloaded!', 'success');
        }
    }
</script>
{% endblock %}